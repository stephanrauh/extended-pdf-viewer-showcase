<div class="flex-container-column fill-container">
  @if (!(fullscreenService.isFullscreen$ | async)) {
    <div class="flex-container-row">
      <div class="bg-white border border-gray-300 rounded-lg shadow-mat-8 p-6 mt-1 flex-1 box-border max-w-[55%]">
        <div class="w-full">
          <!-- Tab buttons -->
          <div class="overflow-x-auto">
            <div class="flex space-x-2 w-max border-b border-gray-200 mb-2">
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="exportannotationscomponentTab === 'livedemo'"
                [class.border-primary-600]="exportannotationscomponentTab === 'livedemo'"
                [class.text-gray-500]="exportannotationscomponentTab !== 'livedemo'"
                [class.border-transparent]="exportannotationscomponentTab !== 'livedemo'"
                (click)="exportannotationscomponentTab = 'livedemo'"
              >
                live demo
              </button>
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="exportannotationscomponentTab === 'forms'"
                [class.border-primary-600]="exportannotationscomponentTab === 'forms'"
                [class.text-gray-500]="exportannotationscomponentTab !== 'forms'"
                [class.border-transparent]="exportannotationscomponentTab !== 'forms'"
                (click)="exportannotationscomponentTab = 'forms'"
              >
                forms
              </button>
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="exportannotationscomponentTab === 'largefiles'"
                [class.border-primary-600]="exportannotationscomponentTab === 'largefiles'"
                [class.text-gray-500]="exportannotationscomponentTab !== 'largefiles'"
                [class.border-transparent]="exportannotationscomponentTab !== 'largefiles'"
                (click)="exportannotationscomponentTab = 'largefiles'"
              >
                large files
              </button>
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="exportannotationscomponentTab === 'idbehavior'"
                [class.border-primary-600]="exportannotationscomponentTab === 'idbehavior'"
                [class.text-gray-500]="exportannotationscomponentTab !== 'idbehavior'"
                [class.border-transparent]="exportannotationscomponentTab !== 'idbehavior'"
                (click)="exportannotationscomponentTab = 'idbehavior'"
              >
                ID behavior
              </button>
            </div>
          </div>

          <!-- Tab content -->
          @if (exportannotationscomponentTab === 'livedemo') {
            <div class="tab-content">
              <p>
                You can export text, drawings, images, and highlights you've added to a PDF file. You can also add texts, highlights, and ink drawings programmatically.
                As for images, that's supported, but using the <a href="./annotation-layer-api">high-level different API</a>.
              </p>
              <p>
                <b>Frequent breaking changes:</b> This API relies on a rapidly evolving internal pdf.js data structure. Every once in a while,
                this results in a breaking change. I try to avoid that - but it happened twice now. At the time being, please be aware that this
                API may break at any time without notice when I update the base library, pdf.js. The latest breaking change is
                version 25.6.0, which fixes the ink editor export. Please bear with me! I'm sure the API will become stable in future.
                But we're not there yet.
              </p>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow mb-1 me-1" (click)="exportAnnotations()">
                Export annotations
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow mb-1 me-1" (click)="addTextEditor()">
                Add text editor
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow mb-1 me-1" (click)="addHighlight()">
                Add highlight (currently broken)
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow mb-1 me-1" (click)="addDrawing()">
                Add ink drawing
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow mb-1 me-1" (click)="removeEditors()">
                Remove editors
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow mb-1 me-1" (click)="removeTextEditors()">
                Remove text editors from page 1
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow mb-1 me-1" (click)="removeDrawingEditors()">
                Remove drawings from page 1
              </button>
            </div>
          }
          @if (exportannotationscomponentTab === 'forms') {
            <div class="tab-content">
              <p>
                Both forms and editor annotations are PDF annotation, so it might happen the APIs get in the way of each other. Until version 19.6.6, clicking
                "remove editors" would also remove the form fields. This has been fixed in version 19.6.7.
              </p>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow" (click)="exportAnnotations()">
                Export annotations
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow" (click)="addTextEditor()">
                Add text editor
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow" (click)="addHighlight()">
                Add highlight (currently broken)
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow" (click)="addDrawing()">
                Add ink drawing
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow" (click)="removeEditors()">
                Remove editors
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow" (click)="removeTextEditors()">
                Remove text editors from page 1
              </button>
              <button class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-2 px-4 rounded shadow" (click)="removeDrawingEditors()">
                Remove drawings from page 1
              </button>
            </div>
          }
          @if (exportannotationscomponentTab === 'largefiles') {
            <div class="tab-content">
              <p>
                The PDF viewer renders pages lazily. If they aren't going to be used soon, the page is not rendered. If you've got a large file, a major part of
                the pages are just placeholders.
              </p>
              <p>
                This, in turn, means you can't add an annotation. If you want to add annotations to large files reliably, catch the event
                <code>(annotationLayerRendered)</code> and add the annotations in the event handler. Not that this event is triggered for every page
                individually. The event handler should add the annotations that belong to this particular page, but not to other pages.
              </p>
            </div>
          }
          @if (exportannotationscomponentTab === 'idbehavior') {
            <div class="tab-content">
              <h3 class="text-lg font-semibold mb-2">Understanding Annotation IDs</h3>
              <p class="mb-3">
                <strong>Added in version 25.6.2:</strong> All annotations now include an <code>id</code> field when exported or accessed via events.
                However, it's important to understand how these IDs work to avoid confusion.
              </p>

              <h4 class="text-md font-semibold mb-2">ID Behavior Summary</h4>
              <ul class="list-disc list-inside mb-3 space-y-1">
                <li><strong>Temporary Only:</strong> IDs are valid only during the current session</li>
                <li><strong>Not Persistent:</strong> When re-applying annotations via <code>addEditorAnnotation()</code>, new IDs are always assigned</li>
                <li><strong>Automatically Ignored:</strong> Any <code>id</code> field in annotations you pass to <code>addEditorAnnotation()</code> is ignored</li>
                <li><strong>Optional for Storage:</strong> You can safely omit the <code>id</code> field when storing annotations for later use</li>
              </ul>

              <h4 class="text-md font-semibold mb-2">When to Use IDs</h4>
              <p class="mb-3">
                IDs are useful for <strong>real-time event tracking</strong>:
              </p>
              <ul class="list-disc list-inside mb-3 space-y-1">
                <li>Responding to <code>(annotationEditorEvent)</code> - the event includes the annotation ID</li>
                <li>Using <code>getSerializedAnnotation(id)</code> to retrieve a specific annotation by its temporary ID</li>
                <li>Tracking changes to specific annotations during a single session</li>
              </ul>

              <h4 class="text-md font-semibold mb-2">Best Practice: Storing Annotations</h4>
              <p class="mb-2">
                When storing annotations for later re-use (e.g., in localStorage or a database), you have two options:
              </p>
              <div class="bg-gray-100 p-3 rounded mb-3 overflow-x-auto">
                <pre class="text-xs"><code>// Option 1: Remove IDs before storing (recommended)
const annotations = pdfService.getSerializedAnnotations();
const toStore = annotations.map((&#123; id, ...rest &#125;) => rest);
localStorage.setItem('annotations', JSON.stringify(toStore));

// Option 2: Keep IDs (they'll be ignored anyway)
const annotations = pdfService.getSerializedAnnotations();
localStorage.setItem('annotations', JSON.stringify(annotations));</code></pre>
              </div>
              <p class="mb-3">
                Both approaches work identically because <code>addEditorAnnotation()</code> always assigns new IDs regardless of whether
                you include the old IDs or not.
              </p>

              <h4 class="text-md font-semibold mb-2">Example: Re-applying Stored Annotations</h4>
              <div class="bg-gray-100 p-3 rounded mb-3 overflow-x-auto">
                <pre class="text-xs"><code>// Re-apply annotations (new IDs will be assigned automatically)
const stored = JSON.parse(localStorage.getItem('annotations'));
await pdfService.addEditorAnnotation(stored);

// The annotations now have NEW IDs, different from when they were exported</code></pre>
              </div>

              <h4 class="text-md font-semibold mb-2">What Happens to IDs?</h4>
              <p class="mb-3">
                When you call <code>addEditorAnnotation()</code> with an annotation that has an <code>id</code> field:
              </p>
              <ul class="list-disc list-inside mb-3 space-y-1">
                <li>The provided <code>id</code> is <strong>completely ignored</strong></li>
                <li>A new unique ID is automatically generated</li>
                <li>No ID collision detection occurs (because old IDs are never used)</li>
                <li>This ensures annotations never interfere with each other</li>
              </ul>

              <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">
                <p class="text-sm">
                  <strong>⚠️ Important:</strong> Do not rely on IDs to persist across document reloads, page refreshes, or sessions.
                </p>
              </div>
            </div>
          }
        </div>
      </div>
      <div class="bg-white border border-gray-300 rounded-lg shadow-mat-8 p-6 mt-1 flex-1 box-border max-w-[43%]">
        <div class="w-full">
          <!-- Tab buttons -->
          <div class="overflow-x-auto">
            <div class="flex space-x-2 w-max border-b border-gray-200 mb-2">
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="codeTab === 'htmltemplate'"
                [class.border-primary-600]="codeTab === 'htmltemplate'"
                [class.text-gray-500]="codeTab !== 'htmltemplate'"
                [class.border-transparent]="codeTab !== 'htmltemplate'"
                (click)="codeTab = 'htmltemplate'"
              >
                HTML template
              </button>
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="codeTab === 'tstext'"
                [class.border-primary-600]="codeTab === 'tstext'"
                [class.text-gray-500]="codeTab !== 'tstext'"
                [class.border-transparent]="codeTab !== 'tstext'"
                (click)="codeTab = 'tstext'"
              >
                TS - text
              </button>
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="codeTab === 'tsdrawing'"
                [class.border-primary-600]="codeTab === 'tsdrawing'"
                [class.text-gray-500]="codeTab !== 'tsdrawing'"
                [class.border-transparent]="codeTab !== 'tsdrawing'"
                (click)="codeTab = 'tsdrawing'"
              >
                TS - drawing
              </button>
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="codeTab === 'tsremovingeditors'"
                [class.border-primary-600]="codeTab === 'tsremovingeditors'"
                [class.text-gray-500]="codeTab !== 'tsremovingeditors'"
                [class.border-transparent]="codeTab !== 'tsremovingeditors'"
                (click)="codeTab = 'tsremovingeditors'"
              >
                TS - removing editors
              </button>
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="codeTab === 'tsexporting'"
                [class.border-primary-600]="codeTab === 'tsexporting'"
                [class.text-gray-500]="codeTab !== 'tsexporting'"
                [class.border-transparent]="codeTab !== 'tsexporting'"
                (click)="codeTab = 'tsexporting'"
              >
                TS - exporting
              </button>
              <button
                class="px-3 py-1.5 text-xs font-medium border-b-2 focus:outline-none"
                [class.text-primary-600]="codeTab === 'livedemo'"
                [class.border-primary-600]="codeTab === 'livedemo'"
                [class.text-gray-500]="codeTab !== 'livedemo'"
                [class.border-transparent]="codeTab !== 'livedemo'"
                (click)="codeTab = 'livedemo'"
              >
                live demo
              </button>
            </div>
          </div>
          </div>

          <!-- Tab content -->
          @if (codeTab === 'htmltemplate') {
            <div class="tab-content">
              <app-ie11-markdown src="/assets/extended-pdf-viewer/export-annotations/html.md"> </app-ie11-markdown>
            </div>
          }
          @if (codeTab === 'tstext') {
            <div class="tab-content">
              <app-ie11-markdown src="/assets/extended-pdf-viewer/export-annotations/ts - add text.md"> </app-ie11-markdown>
            </div>
          }
          @if (codeTab === 'tsdrawing') {
            <div class="tab-content">
              <app-ie11-markdown src="/assets/extended-pdf-viewer/export-annotations/ts - add drawing.md"> </app-ie11-markdown>
            </div>
          }
          @if (codeTab === 'tsremovingeditors') {
            <div class="tab-content">
              <app-ie11-markdown src="/assets/extended-pdf-viewer/export-annotations/ts - removing.md"> </app-ie11-markdown>
            </div>
          }
          @if (codeTab === 'tsexporting') {
            <div class="tab-content">
              <app-ie11-markdown src="/assets/extended-pdf-viewer/export-annotations/ts - export.md"> </app-ie11-markdown>
            </div>
          }
          @if (codeTab === 'livedemo') {
            <div class="tab-content">
              <div class="mt-3">
                @if (rawAnnotations) {
                  <div>
                    <p>You can edit the annotations. Click outside the text areas to trigger rendering.</p>
                    @for (anno of rawAnnotations; track anno; let i = $index) {
                      <ol>
                        <li>
                          <textarea
                            [value]="rawAnnotations[i] | json"
                            (change)="updateAnnotation(i, $event)"
                            (input)="adjustSize($event)"
                            rows="{{ countRows(rawAnnotations[i] | json) }}"
                            cols="60"
                          ></textarea>
                        </li>
                      </ol>
                    }
                  </div>
                }
                @if (!rawAnnotations) {
                  <div>No annotations. Use the editor or the buttons to add text or drawings to the PDF file.</div>
                }
              </div>
            </div>
          }
        </div>
    </div>
  }

  <app-demo [src]="src">
    <ngx-extended-pdf-viewer [src]="src" [textLayer]="true" [showHandToolButton]="true" [handTool]="false"
      [theme]="theme"> </ngx-extended-pdf-viewer>
  </app-demo>
</div>
